<!-----------------------------------------------------------------------------
 -
 - Copyright 2019 IBM Corporation and others.
 -
 - Licensed under the Apache License, Version 2.0 (the "License");
 - you may not use this file except in compliance with the License.
 - You may obtain a copy of the License at
 -
 -     http://www.apache.org/licenses/LICENSE-2.0
 -
 - Unless required by applicable law or agreed to in writing, software
 - distributed under the License is distributed on an "AS IS" BASIS,
 - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 - See the License for the specific language governing permissions and
 - limitations under the License.
 -
 ------------------------------------------------------------------------------>

<div id="content">
    <div id="general_title"> Kabanero Foundation Setup
    </div>

    <!-- General reference content section -->
    <div class="paragraph">
<p>The Kabanero Foundation is installed in a Kubernetes cluster.  For specific Kubernetes providers and resource pre-requisites, refer to documentation at <a href="https://github.com/kabanero-io/roadmap#kabanero-foundation" class="bare">https://github.com/kabanero-io/roadmap#kabanero-foundation</a>.</p>
</div>
<div class="paragraph">
<p>Having an appropriate Kubernetes cluster built and defined, we are ready to build our Kabanero Foundation instance.</p>
</div>
<div class="paragraph">
<p>The Kabanero Foundation is installed and managed using a Kubernetes Operator.  Kabanero is built on Knative, Istio and leverages Tekton for pipeline management.</p>
</div>
<div class="sect2">
<h3 id="kabanero-operator">Kabanero Operator</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ensure you have <code>cluster-admin</code> access to an OpenShift or OKD cluster and have installed the <a href="https://github.com/kabanero-io/kabanero-operator">Kabanero operator</a>.  (This documentation assumes that we will deploy the Kabanero Foundation in the <code>kabanero</code> Kubernetes namespace.)</p>
<div class="literalblock">
<div class="content">
<pre>oc new-project kabanero
oc project kabanero
oc apply -f https://raw.githubusercontent.com/kabanero-io/kabanero-operator/master/deploy/dependencies.yaml
oc apply -f https://raw.githubusercontent.com/kabanero-io/kabanero-operator/master/deploy/releases/0.0.1/kabanero-operator.yaml
oc apply -f https://raw.githubusercontent.com/kabanero-io/kabanero-operator/master/config/samples/full.yaml</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="istio">Istio</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The Kabanero Foundation requires Istio.  Istio is not yet installed by the Kabanero operator.  Install it:</p>
<div class="listingblock">
<div class="content">
<pre>oc adm policy add-scc-to-user anyuid -z istio-ingress-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z default -n istio-system
oc adm policy add-scc-to-user anyuid -z prometheus -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-egressgateway-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-citadel-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-ingressgateway-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-cleanup-old-ca-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-mixer-post-install-account -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-mixer-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-pilot-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-sidecar-injector-service-account -n istio-system
oc adm policy add-cluster-role-to-user cluster-admin -z istio-galley-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z cluster-local-gateway-service-account -n istio-system
kubectl apply --filename https://github.com/knative/serving/releases/download/v0.4.0/istio-crds.yaml &amp;&amp;
curl -L https://github.com/knative/serving/releases/download/v0.4.0/istio.yaml \
  | sed 's/LoadBalancer/NodePort/' \
  | kubectl apply --filename -</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="tekton-pipeline">Tekton Pipeline</h3>
<div class="paragraph">
<p>The Kabanero Foundation uses Tekton Pipelines to build and deploy micro-services built with Appsody, and the Appsody application is stored in a public GitHub Repository.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If the GitHub repository is private, refer to the <a href="https://github.com/tektoncd/pipeline/blob/master/docs/auth.md">Tekton Authentication Documentation</a> on how to add github credentials to your pipeline task or run.</p>
</li>
<li>
<p>For the example pipeline, your Kubernetes cluster needs access to a Docker registry, such as <a href="https://hub.docker.com/">Docker Hub</a> (<em>I.e.</em>, permission to pull and push images). Alternatively, you can use the <a href="https://docs.openshift.com/container-platform/3.11/install_config/registry/">Internal Openshift Registry</a>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="setting-up-the-example-appsody-pipeline">Setting up the example Appsody pipeline</h3>
<div class="paragraph">
<p>This repo contains an example of a <a href="https://github.com/tektoncd/pipeline">Tekton pipeline</a> that builds and deploys an application created with <a href="https://appsody.dev">Appsody</a> to a <a href="https://github.com/kabanero-io">Kabanero</a> managed cluster.</p>
</div>
<div class="paragraph">
<p>The Appsody application repository includes a Knative Serving manifest file called <code>appsody-service.yaml</code>. We&#8217;ll discuss this aspect in more detail later on.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Clone the appsody <a href="https://github.com/appsody/tekton-example">tekton-example</a> repository. This repository contains the pipeline manifests.</p>
<div class="literalblock">
<div class="content">
<pre>git clone https://github.com/appsody/tekton-example.git</pre>
</div>
</div>
</li>
<li>
<p>Ensure that you are creating all resources in the previously created <code>kabanero</code> namespace.</p>
</li>
<li>
<p>Since the Tekton pipeline needs to deploy to the cluster itself, you want to ensure that it runs under an identity that has cluster administrator privileges.</p>
<div class="paragraph">
<p>For this reason, create a service account, the appropriate cluster role binding, and hostmount-anyuid access by issuing:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>kubectl apply -f appsody-service-account.yaml
oc adm policy add-cluster-role-to-user cluster-admin -z appsody-sa -n kabanero
oc adm policy add-scc-to-user hostmount-anyuid -z appsody-sa -n kabanero</pre>
</div>
</div>
<div class="paragraph">
<p>The previous commands set up a service account called <code>appsody-sa</code> and grant the <code>cluster-admin</code> role to it. The pipeline you are going to create uses this service account.</p>
</div>
</li>
<li>
<p>Next, create and associate a secret holding the credentials for the Docker registry where you want to push the resultant image of your sample pipeline build.</p>
</li>
<li>
<p>If using the <a href="https://docs.openshift.com/container-platform/3.11/install_config/registry/">Internal Openshift Registry</a>, add the <a href="https://docs.openshift.com/container-platform/3.11/dev_guide/service_accounts.html#default-service-accounts-and-roles">image-builder</a> role to the <code>appsody-sa</code> service account so it has push access. The internal registry secret is automatically associated with the <code>appsody-sa</code> service account by Openshift, and now as access to push images into project.</p>
<div class="literalblock">
<div class="content">
<pre>oc policy add-role-to-user system:image-builder system:serviceaccount:kabanero:appsody-sa</pre>
</div>
</div>
</li>
<li>
<p>If using an external registry, create a secret.
In the example below, this secret will be used when the pipeline build is attempting to authenticate with <code>https://index.docker.io/v1/</code>. <code>my-docker-secret</code> is the name of secret that we will reference later.
You may use any name you wish.</p>
<div class="literalblock">
<div class="content">
<pre>apiVersion: v1
kind: Secret
metadata:
  name: my-docker-secret
  annotations:
    tekton.dev/docker-0: https://index.docker.io/v1/
type: kubernetes.io/basic-auth
stringData:
  username: &lt;your docker userid&gt;
  password: &lt;your docker password&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Edit the yaml file <code>my-docker-secret.yaml</code>, making sure to replace the username and password values with your own values.  Then run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>kubectl apply -f my-docker-secret.yaml</pre>
</div>
</div>
</li>
<li>
<p>Make the Docker registry credentials available to the pipeline by adding your docker secret to the <code>appsody-sa</code> service account. This can be accomplished by editing the service account, using the following command:</p>
<div class="literalblock">
<div class="content">
<pre>kubectl edit serviceaccount appsody-sa</pre>
</div>
</div>
<div class="paragraph">
<p>An editor opens up. Add your secret to the list of secrets, as shown in the example below:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>...
secrets:
- name: appsody-sa-token-ldzbq
- name: my-docker-secret</pre>
</div>
</div>
<div class="paragraph">
<p>Save the changes.</p>
</div>
</li>
<li>
<p>Now, create the pipeline task and the pipeline definition. We have a simple pipeline, with a single task that performs the various steps of building and deploying the project:</p>
<div class="paragraph">
<p>Modify <code>appsody-build-task.yaml</code> and add this environment variable to the build-push-step step:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>...
      env:
      - name: DOCKER_CONFIG
        value: /builder/home/.docker</pre>
</div>
</div>
<div class="paragraph">
<p>If you are using the Internal Openshift Registry, add the arg <code>--skip-tls-verify</code> to the executor command</p>
</div>
<div class="literalblock">
<div class="content">
<pre>...
      command:
        - /kaniko/executor
      args:
        - --skip-tls-verify</pre>
</div>
</div>
<div class="paragraph">
<p>Apply the manifests</p>
</div>
<div class="literalblock">
<div class="content">
<pre>kubectl apply -f appsody-build-task.yaml
kubectl apply -f appsody-build-pipeline.yaml</pre>
</div>
</div>
</li>
<li>
<p>The pipeline requires the definition of two resources in order to operate:</p>
<div class="ulist">
<ul>
<li>
<p>The definition of the Docker image that is built and deployed by the pipeline itself</p>
</li>
<li>
<p>The location of the GitHub project that contains your Appsody code</p>
<div class="paragraph">
<p>For this reason, you need to edit the <code>appsody-pipeline-resources.yaml</code>. Change the value of the Docker image url to match your settings:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>...
spec:
  params:
  - name: url
    value: index.docker.io/your-userid/my-appsody-image</pre>
</div>
</div>
<div class="paragraph">
<p>And change the definition of your GitHub project:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>...
spec:
  params:
  - name: revision
    value: master
  - name: url
    value: https://github.com/your-userid/appsody-test-build</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Once you have edited the resources, apply them to your cluster:</p>
<div class="literalblock">
<div class="content">
<pre>kubectl apply -f appsody-pipeline-resources.yaml</pre>
</div>
</div>
</li>
<li>
<p>The Tekton buld pipeline requires a Persistent Volume. If you do not have a default dynamic storage provider, create a hostPath volume:</p>
<div class="literalblock">
<div class="content">
<pre>apiVersion: v1
kind: PersistentVolume
metadata:
  name: appsody-manual-pipeline-run-pvc
spec:
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: /var/lib/appsody-manual-pipeline-run-pvc</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The Tekton pipeline is now fully set up.</p>
</div>
</div>
<div class="sect2">
<h3 id="a-few-words-on-the-required-deployment-manifest">A few words on the required deployment manifest</h3>
<div class="paragraph">
<p>As we mentioned earlier, the pipeline is designed to deploy your application to the Kubernetes cluster as a Knative Serving service. The pipeline expects a deployment manifest located within your project - specifically, it expects to run <code>kubectl apply</code> against a file named <code>appsody-service.yaml</code>.</p>
</div>
<div class="paragraph">
<p>Here we provide an example of such a deployment manifest:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>apiVersion: serving.knative.dev/v1alpha1
kind: Service
metadata:
  name: appsody-project
spec:
  runLatest:
    configuration:
      revisionTemplate:
        spec:
          container:
            image: mydockeraccount/appsody-project
            imagePullPolicy: Always
            ports:
            - containerPort: 3000</pre>
</div>
</div>
<div class="paragraph">
<p>The file can be located anywhere within your project, since the pipeline will discover it.</p>
</div>
<div class="paragraph">
<p>Notice that the image url must match the definition of the Docker image resource that you created for the pipeline. The <code>containerPort</code> must be set to the port number on which the server inside the Appsody stack is configured to listen.</p>
</div>
<div class="paragraph">
<p>One way to obtain a manifest file that has all the matching settings is to run the <code>appsody deploy</code> command, as described in <a href="https://appsody.dev/docs">the Appsody documentation</a>.</p>
</div>
<div class="paragraph">
<p>It must be noted, however, that the pipeline can work with any deployment manifest - not limited to Knative Serving services. Its current implementation applies whatever deployment manifest is contained in <code>appsody-service.yaml</code>.</p>
</div>
<div class="paragraph">
<p>The file name can be modified by simply changing the relevant line in <code>appsody-build-pipeline.yaml</code>, as pointed out here:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>      params:
      - name: appsody-deploy-file-name
        value: appsody-service.yaml</pre>
</div>
</div>
<div class="paragraph">
<p>Also, if you wanted to retrieve a deployment manifest from a different repository, rather than assuming its presence in the application code repository, you could modify this section of <code>appsody-build-task.yaml</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>    - name: install-knative
      image: lachlanevenson/k8s-kubectl
      command: ['/bin/sh']
      args: ['-c', 'find /workspace/extracted -name ${YAMLFILE} -type f|xargs kubectl apply -f']
      env:
        - name: YAMLFILE
          value: ${inputs.params.appsody-deploy-file-name}</pre>
</div>
</div>
<div class="paragraph">
<p>The implementation we have provided assumes the deployment manifest is in the <code>workspace\extracted</code> directory, which contains a clone of the source repository - but it could be adjusted to obtain that file from a different source.</p>
</div>
</div>
<div class="sect2">
<h3 id="running-the-pipeline-manually">Running the pipeline manually</h3>
<div class="paragraph">
<p>This repo provides a manual trigger (via a PipelineRun resource) that you can use to kick off the pipeline on your cluster.</p>
</div>
<div class="paragraph">
<p>Run the following command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>kubectl apply -f appsody-pipeline-run.yaml</pre>
</div>
</div>
<div class="paragraph">
<p>A new pod will be launched in the "kabanero" namespace with the name similar to:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>appsody-manual-pipeline-run-appsody-build-t9g87-pod-6c00e4</pre>
</div>
</div>
<div class="paragraph">
<p>To view the logs from the running pipeline, use this command, tailored for the specific id of your pod:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>kubectl logs appsody-manual-pipeline-run-appsody-build-t9g87-pod-6c00e4 -n kabanero --all-containers</pre>
</div>
</div>
<div class="paragraph">
<p>In that output, you will see the output from the pipeline build.</p>
</div>
<div class="paragraph">
<p>To re-run another build, first delete the existing pipeline-run before re-running the apply command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>kubectl delete -f appsody-pipeline-run.yaml</pre>
</div>
</div>
</div>
</div>